<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KoaSayi</title>
  <script>
    // Apply stored theme early to prevent flash of incorrect theme
    (function(){
      try {
        var s = localStorage.getItem('theme');
        if (s) document.documentElement.setAttribute('data-theme', s);
        else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.setAttribute('data-theme','dark');
      } catch (e) { /* ignore */ }
    })();
  </script>
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* Liquid glass styling for main article boxes and aero cards */
    .post, .aero-card {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: 0 10px 30px rgba(2,8,20,0.6), inset 0 1px rgba(255,255,255,0.02);
      backdrop-filter: blur(10px) saturate(120%);
      -webkit-backdrop-filter: blur(10px) saturate(120%);
      border-radius: 8px;
      padding: 18px;
      color: var(--text); /* use theme variable so light-mode gets dark text and dark-mode keeps light text */
    }

    /* Make anchor-based aero-cards behave like blocks */
    .aero-card { display: block; text-decoration: none; color: inherit; }

    /* Removed solid black blocks — use transparent backgrounds and inherited text color */
    .post .post-title,
    .post .post-meta,
    .post p,
    .post .read-more,
    .aero-card h4,
    .aero-card p,
    .card h3,
    .card p {
      background: transparent;
      color: inherit;
      padding: 6px 10px;
      border-radius: 6px;
      line-height: 1.35;
      display: inline-block;
    }

    /* Tweak meta and paragraph appearance */
    .post .post-meta { display: block; margin: 8px 0 12px 0; color: inherit; background: transparent; padding: 6px 10px; }
    .post p { color: inherit; margin: 0 0 12px 0; display: block; }
    .post .read-more { color: inherit; background: transparent; padding: 6px 10px; border-radius: 6px; }

    /* Hover lift for visual polish */
    .post:hover, .aero-card:hover { transform: translateY(-4px); box-shadow: 0 20px 50px rgba(2,8,20,0.65); transition: all .22s ease; }

    /* New: glass title bar and pinned badge for first article */
    .pinned-post { position: relative; padding-top: 46px; }
    .pinned-post .pinned {
      position: absolute;
      top: 12px;
      left: 12px;
      background: linear-gradient(135deg, rgba(239,68,68,0.95), rgba(220,38,38,0.9));
      color: #fff;
      padding: 6px 10px;
      border-radius: 10px;
      font-weight: 700;
      box-shadow: 0 8px 22px rgba(0,0,0,0.45);
      border: 1px solid rgba(255,255,255,0.06);
      backdrop-filter: blur(6px);
      z-index: 10;
      font-size: 13px;
    }
    .title-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 10px;
      margin-bottom: 8px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: 0 6px 18px rgba(2,8,20,0.18);
      color: inherit;
    }
    .title-bar .post-title { margin: 0; font-size: 1.125rem; padding: 0; display: block; background: transparent; }

    @media (max-width: 520px) {
      .post .post-title, .post .post-meta, .post p { display: block; padding: 8px; }
      .pinned-post { padding-top: 56px; }
      .pinned-post .pinned { top: 8px; left: 8px; }
    }
  </style>
</head>

<body class="preloading">
  <!-- Preload overlay (index only) -->
  <div id="preload-overlay" aria-hidden="false">
    <div class="pre-title">KoaSayi</div>
    <div class="progress-label">Loading</div>
    <div class="progress-wrap"><div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"></div></div>
  </div>

  <header class="site-header">
    <div class="wrap">
      <h1 class="site-title">KoaSayi</h1>
      <p class="site-desc">IT-服务、交流与发展</p>
      <button id="theme-toggle" class="theme-toggle" aria-label="切换主题">换！</button>
    </div>
  </header>

  <div id="cookie-points" aria-hidden="true"></div>

  <nav class="site-nav">
    <div class="wrap">
      <a href="#">home</a>
      <a href="web/friends.html">Friends</a>
      <a href="web/about.html">about</a>
      <div class="actions" style="margin-left:12px;">
        <a class="nav-action" id="nav-home" href="index.html"><span>KoaSayi</span></a>
        <a class="nav-action" id="nav-furina" href="https://furina64.dpdns.org/openlist" target="_blank" rel="noopener"><span>FurinaFile</span></a>
        <button class="nav-action" id="nav-search" type="button" aria-label="Search"><span>Search</span></button>
        <a class="nav-action" id="nav-issues" href="https://github.com/KoaSayi/KoaSayi-s-blog-/issues" target="_blank" rel="noopener"><span>issues</span></a>
      </div>
    </div>
  </nav>

  <!-- Cookie consent popup (interactive) -->
  <div id="cookie-popup" class="hidden" role="dialog" aria-label="Cookie consent">
    <button class="cp-close" aria-label="关闭">✕</button>
    <div class="cp-title">您是否要接受所有 cookies？</div>
    <div class="cp-body">从KoaSayi不知道哪来的点子，反正你接不接受吧。</div>
    <div class="cp-actions">
      <div class="cookie-action blue" id="cookie-accept">接受cookies</div>
      <div class="cookie-action blue partial" id="cookie-partial">接受部分cookies</div>
      <div class="cookie-action reject" id="cookie-reject">拒绝</div>
    </div>
  </div>

  <!-- Search overlay -->
  <div id="search-overlay" aria-hidden="true">
    <div class="search-bar" role="dialog" aria-label="Search">
      <input class="search-input" id="search-input" placeholder="输入搜索关键词..." />
      <div class="search-hint">搜索文章......</div>
    </div>
    <div class="search-results" id="search-results" aria-live="polite"></div>
  </div>

  <main class="wrap main-grid">
    <section class="content">

      <!-- New pinned glass title article (Cookies 不是真的 Cookies) -->
      <article class="post pinned-post">
        <div class="pinned">置顶</div>
        <div class="title-bar">
          <h2 class="post-title">Cookies不是真的Cookies</h2>
          <div class="title-meta">说明 · 快速查看</div>
        </div>
        <p class="post-meta">2026-02-14 · KoaSayi</p>
        <p>“Cookies 点数”与浏览器存储相关，不上传个人信息。点击此玻璃栏左下角一口气看到大结局</p>
        <p><a class="read-more" href="web/Writing/Cookiesinformation.html">阅读更多 →</a></p>
      </article>

      <article class="post">
        <div class="title-bar">
          <h2 class="post-title">此网页还在开发中！</h2>
          <div class="title-meta">快速导览</div>
        </div>
        <p class="post-meta">2025-12-04 · 分类：- · 阅读：- 分钟</p>
        <p>正在重拾自己的博客计划。
          目前打算想办法把之前写的一些文章整理出来，放到这个博客上..</p>
        <p><a class="read-more" href="web/Writing/post-detail.html">阅读更多 →</a></p>
      </article>

      <article class="post">
        <h2 class="post-title">正式文章：离谱的事。</h2>
        <p class="post-meta" style="">2025-12-11 · 分类：Koa现实Sayi-</p>
        <p>何意义。</p>
        <p><a class="read-more" href="web/Writing/post-detail.html">阅读更多 →</a></p>
      </article>

    </section>

    <aside class="sidebar">
      <div class="card">
        <h3>about KoaSayi</h3>
        <p>只是一个学生。现在上海定居。</p>
      </div>

      <div class="card">
        <h3>contact</h3>
        <p>邮箱：<a href="mailto:hdb97028@gmail.com">hdb97028@gmail.com</a></p>
      </div>

      <!-- 四个 Windows Aero 风格的方块 -->
      <div class="aero-grid">
        <a class="aero-card" href="#quick-links">
          <h4>Quick Links</h4>
          <p>常用链接，方便访问。</p>
        </a>
        <a class="aero-card" href="#latest">
          <h4>Latest</h4>
          <p>最近的更新与日志。</p>
        </a>
        <a class="aero-card" href="https://github.com/KoaSayi/KoaSayi-s-blog-" target="_blank" rel="noopener">
          <h4>Projects</h4>
          <p>正在进行的项目预览。</p>
        </a>
        <a class="aero-card" href="#tips">
          <h4>Tips</h4>
          <p>小技巧与学习资源。</p>
        </a>
      </div>
    </aside>
  </main>

  <footer class="site-footer">
    <div class="wrap">
      <p>© 2025 KoaSayi。</p>
    </div>
  </footer>

  <!-- 修复玻璃按钮（默认隐藏） -->
  <button id="repair-btn" aria-hidden="true">一键修复</button>

  <script>
    (function () {
      const doc = document.documentElement;
      const toggle = document.getElementById('theme-toggle');
      const repairBtn = document.getElementById('repair-btn');
      const clickState = new WeakMap();

      // Utilities
      const $ = (sel, ctx = document) => ctx.querySelector(sel);
      const $$ = (sel, ctx = document) => Array.from(ctx.querySelectorAll(sel));

      function safeSetTheme(theme) {
        if (!theme) return;
        doc.setAttribute('data-theme', theme);
        try { localStorage.setItem('theme', theme); } catch (e) { /* ignore */ }
      }

      // Theme init
      const stored = (function () { try { return localStorage.getItem('theme'); } catch (e) { return null; } })();
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      safeSetTheme(stored === 'dark' || (!stored && prefersDark) ? 'dark' : 'light');

      function updateIcon() {
        const isDark = doc.getAttribute('data-theme') === 'dark';
        if (toggle) toggle.textContent = isDark ? '我怕暗' : '我怕亮';
      }

      if (toggle) {
        toggle.addEventListener('click', () => {
          const isDark = doc.getAttribute('data-theme') === 'dark';
          const next = isDark ? 'light' : 'dark';
          safeSetTheme(next);
          updateIcon();
        });
      }

      if (window.matchMedia) {
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
          try {
            if (!localStorage.getItem('theme')) {
              safeSetTheme(e.matches ? 'dark' : 'light');
              updateIcon();
            }
          } catch (err) { /* ignore */ }
        });
      }

      updateIcon();

      // ---------- Nav actions (KoaSayi, FurinaFile, Search, issues) ----------
      const navHome = $('#nav-home');
      const navFurina = $('#nav-furina');
      const navSearch = $('#nav-search');
      const navIssues = $('#nav-issues');
      const searchOverlay = $('#search-overlay');
      const searchInput = $('#search-input');
      const searchResults = $('#search-results');

      if (navHome) navHome.addEventListener('click', e => { e.preventDefault(); location.href = 'index.html'; });
      if (navFurina) navFurina.addEventListener('click', () => {}); // normal link
      if (navIssues) navIssues.addEventListener('click', () => {});

      function openSearch() {
        if (!searchOverlay) return;
        const bar = searchOverlay.querySelector('.search-bar');
        searchOverlay.classList.add('visible');
        if (bar) bar.classList.add('visible');
        searchOverlay.setAttribute('aria-hidden', 'false');
        // autofocus
        setTimeout(() => { try { searchInput && searchInput.focus(); } catch(e){} }, 120);
      }

      function closeSearch() {
        if (!searchOverlay) return;
        // start fade-out
        const bar = searchOverlay.querySelector('.search-bar');
        if (bar) bar.classList.remove('visible');
        searchOverlay.classList.remove('visible');
        searchOverlay.setAttribute('aria-hidden', 'true');
        searchResults && searchResults.classList.remove('visible');

        // wait for overlay transition to finish before clearing content so fade-out is visible
        const onTransitionEnd = (ev) => {
          if (ev.target !== searchOverlay || ev.propertyName !== 'opacity') return;
          try { searchResults && (searchResults.innerHTML = ''); } catch (e) {}
          try { if (searchInput) searchInput.value = ''; } catch (e) {}
          searchOverlay.removeEventListener('transitionend', onTransitionEnd);
        };
        searchOverlay.addEventListener('transitionend', onTransitionEnd);
      }

      if (navSearch) {
        navSearch.addEventListener('click', () => { openSearch(); });
      }

      if (searchOverlay) {
        searchOverlay.addEventListener('click', e => {
          if (e.target === searchOverlay) closeSearch();
        });
      }

      // search behavior: look for articles on the page whose title contains any character from input
      function runSearch(q) {
        const sanitized = String(q || '').trim();
        searchResults.innerHTML = '';
        if (!sanitized) return showNoResults();

        // collect unique characters from query (ignore spaces)
        const chars = Array.from(new Set(sanitized.replace(/\s+/g, '').split('')));

        // find article titles on the page
        const titles = Array.from(document.querySelectorAll('.post'));
        const matches = [];
        titles.forEach(post => {
          const titleEl = post.querySelector('.post-title');
          if (!titleEl) return;
          const titleText = titleEl.textContent || '';
          // match if any character from query appears in title
          const matched = chars.some(ch => titleText.indexOf(ch) !== -1);
          if (matched) {
            // find a link to the article (read-more) if present
            const linkEl = post.querySelector('.read-more');
            const href = linkEl ? linkEl.getAttribute('href') || '#' : '#';
            matches.push({ title: titleText.trim(), href });
          }
        });

        if (matches.length === 0) return showNoResults();

        matches.forEach(m => {
          const a = document.createElement('a');
          a.className = 'result-tile';
          a.href = m.href || '#';
          a.textContent = m.title;
          a.addEventListener('click', e => {
            // let normal navigation happen; close overlay
            closeSearch();
          });
          searchResults.appendChild(a);
        });
        searchResults.classList.add('visible');
      }

      function showNoResults() {
        searchResults.innerHTML = '';
        const div = document.createElement('div');
        div.className = 'no-results';
        div.textContent = '未找到结果';
        searchResults.appendChild(div);
        searchResults.classList.add('visible');
      }

      if (searchInput) {
        let typingTimer = null;
        searchInput.addEventListener('input', e => {
          clearTimeout(typingTimer);
          typingTimer = setTimeout(() => runSearch(e.target.value), 220);
        });
        searchInput.addEventListener('keydown', e => {
          if (e.key === 'Escape') closeSearch();
          if (e.key === 'Enter') runSearch(e.target.value);
        });
      }

      // close search with ESC globally
      document.addEventListener('keydown', e => { if (e.key === 'Escape') { closeSearch(); } });

      // ---------- Cookie consent logic ----------
      const cookiePopup = document.getElementById('cookie-popup');
      const cookieAccept = document.getElementById('cookie-accept');
      const cookiePartial = document.getElementById('cookie-partial');
      const cookieReject = document.getElementById('cookie-reject');
      const cookieClose = cookiePopup && cookiePopup.querySelector('.cp-close');
      const cookiePointsEl = document.getElementById('cookie-points');

      // Keys in localStorage:
      // "cookie_points" -> integer total points
      // "cookie_prompt_info" -> { date: 'YYYY-MM-DD', count: number, lastTs: 0 }

      function readPromptInfo() {
        try { const s = localStorage.getItem('cookie_prompt_info'); return s ? JSON.parse(s) : { date: null, count: 0, lastTs: 0 }; } catch (e) { return { date: null, count: 0, lastTs: 0 }; }
      }
      function writePromptInfo(info) { try { localStorage.setItem('cookie_prompt_info', JSON.stringify(info)); } catch (e) {} }

      function canPromptNow() {
        const info = readPromptInfo();
        const now = Date.now();
        const today = new Date().toISOString().slice(0,10);
        if (info.date !== today) {
          // reset daily
          info.date = today; info.count = 0; info.lastTs = 0; writePromptInfo(info);
        }
        if (info.count >= 10) return false;
        if (now - (info.lastTs || 0) < 30 * 60 * 1000) return false; // must be > 30 minutes
        return true;
      }

      function recordPrompt() {
        const info = readPromptInfo();
        const now = Date.now();
        const today = new Date().toISOString().slice(0,10);
        if (info.date !== today) { info.date = today; info.count = 1; info.lastTs = now; }
        else { info.count = (info.count || 0) + 1; info.lastTs = now; }
        writePromptInfo(info);
      }

      function readPoints() { try { return parseInt(localStorage.getItem('cookie_points')||'0',10)||0; } catch (e) { return 0; } }
      function writePoints(v) { try { localStorage.setItem('cookie_points', String(v)); } catch (e) {} }

      function updatePointsDisplay() {
        const pts = readPoints();
        if (!pts) {
          cookiePointsEl.classList.remove('visible');
          cookiePointsEl.setAttribute('aria-hidden','true');
        } else {
          cookiePointsEl.classList.add('visible');
          cookiePointsEl.setAttribute('aria-hidden','false');
          cookiePointsEl.textContent = `Cookies: ${pts}`;
        }
      }

      // show popup only on index (as requested) but points are shared across pages
      function maybeShowCookiePopup() {
        // Do not interrupt if popup already dismissed this session
        if (!cookiePopup) return;
        const dismissed = sessionStorage.getItem('cookie_popup_dismissed');
        if (dismissed) return;
        if (!canPromptNow()) return;
        // show
        cookiePopup.classList.remove('hidden');
        recordPrompt();
      }

      function closeCookiePopup(rememberSession=true) {
        if (!cookiePopup) return;
        cookiePopup.classList.add('hidden');
        if (rememberSession) sessionStorage.setItem('cookie_popup_dismissed','1');
      }

      if (cookieClose) cookieClose.addEventListener('click', e => { e.preventDefault(); closeCookiePopup(true); });

      if (cookieAccept) cookieAccept.addEventListener('click', () => {
        const cur = readPoints();
        writePoints(cur + 10);
        updatePointsDisplay();
        closeCookiePopup(true);
      });
      if (cookiePartial) cookiePartial.addEventListener('click', () => {
        const cur = readPoints();
        writePoints(cur + 5);
        updatePointsDisplay();
        closeCookiePopup(true);
      });
      if (cookieReject) cookieReject.addEventListener('click', () => {
        // do not store points; simply dismiss
        closeCookiePopup(true);
      });

      // initialize points display on load
      updatePointsDisplay();

      // attempt to show popup after page load (not to block render)
      window.addEventListener('load', () => {
        setTimeout(() => { try { maybeShowCookiePopup(); } catch (e) {} }, 800);
      });

      // expose update function for other pages to call on their load
      window.KoaSayiCookie = { updatePointsDisplay };

      // ---------- Aero shatter logic ----------
      function resetCount(card) {
        const s = clickState.get(card) || { count: 0, timer: null };
        s.count = 0;
        if (s.timer) { clearTimeout(s.timer); s.timer = null; }
        clickState.set(card, s);
      }

      function incrementClick(card) {
        const s = clickState.get(card) || { count: 0, timer: null };
        s.count += 1;
        if (s.timer) clearTimeout(s.timer);
        s.timer = setTimeout(() => { s.count = 0; s.timer = null; clickState.set(card, s); }, 1200);
        clickState.set(card, s);
        return s.count;
      }

      function showRepair(yes) {
        if (!repairBtn) return;
        repairBtn.classList.toggle('visible', !!yes);
        repairBtn.setAttribute('aria-hidden', yes ? 'false' : 'true');
      }

      function generateRandomPolygon() {
        const points = [];
        const cx = 45 + Math.random() * 10;
        const cy = 40 + Math.random() * 20;
        const count = 4 + Math.floor(Math.random() * 3);
        for (let i = 0; i < count; i++) {
          const angle = (Math.PI * 2 / count) * i + (Math.random() - 0.5) * 0.6;
          const r = 22 + Math.random() * 55;
          const x = Math.max(0, Math.min(100, cx + Math.cos(angle) * r));
          const y = Math.max(0, Math.min(100, cy + Math.sin(angle) * r));
          points.push(`${x}% ${y}%`);
        }
        return points;
      }

      function shatter(card, pointerX, pointerY) {
        if (!card) return;
        // allow multiple shatters: keep an array of overlays per card
        const maxOverlays = 4;
        card.classList.add('shattered');
        const rect = card.getBoundingClientRect();
        const cx = (pointerX !== undefined ? pointerX : (rect.left + rect.width / 2)) - rect.left;
        const cy = (pointerY !== undefined ? pointerY : (rect.top + rect.height / 2)) - rect.top;

        // manage overlays array
        const overlays = card._crackOverlays || [];
        if (overlays.length >= maxOverlays) {
          // fade out and remove the oldest overlay to make room
          const old = overlays.shift();
          if (old) {
            old.style.transition = 'opacity .35s ease';
            old.style.opacity = '0';
            setTimeout(() => { try { old.parentNode && old.parentNode.removeChild(old); } catch (e) {} }, 380);
          }
        }

        // create overlay container
        const overlay = document.createElement('div');
        overlay.className = 'crack-overlay';
        // use overlay index as data-crack for variety
        const nextIndex = (overlays.length % 3) + 1;
        overlay.setAttribute('data-crack', card.dataset.crack || String(nextIndex));
        overlay.style.pointerEvents = 'none';

        // add SVG cracks for fine lines
        const svgNS = 'http://www.w3.org/2000/svg';
        const svg = document.createElementNS(svgNS, 'svg');
        svg.setAttribute('class', 'crack-svg');
        svg.setAttribute('viewBox', `0 0 ${rect.width} ${rect.height}`);
        svg.setAttribute('preserveAspectRatio', 'none');

        const lines = 8 + Math.floor(Math.random() * 6);
        for (let i = 0; i < lines; i++) {
          const angle = (Math.PI * 2 / lines) * i + (Math.random() - 0.5) * 0.6;
          const len = Math.max(rect.width, rect.height) * (0.25 + Math.random() * 0.9);
          const x2 = cx + Math.cos(angle) * len;
          const y2 = cy + Math.sin(angle) * len;
          const path = document.createElementNS(svgNS, 'path');
          path.setAttribute('d', `M ${cx} ${cy} Q ${(cx + x2) / 2 + (Math.random()-0.5)*30} ${(cy + y2) / 2 + (Math.random()-0.5)*30}, ${x2} ${y2}`);
          path.setAttribute('stroke', 'rgba(255,255,255,0.18)');
          path.setAttribute('stroke-width', (Math.random() * 1.2 + 0.6).toString());
          path.setAttribute('fill', 'none');
          path.setAttribute('stroke-linecap', 'round');
          path.setAttribute('class', 'crack-line');
          svg.appendChild(path);
        }

        const impact = document.createElement('div');
        impact.className = 'impact-spot';
        impact.style.left = `${cx - 18}px`;
        impact.style.top = `${cy - 18}px`;

        overlay.appendChild(svg);
        overlay.appendChild(impact);
        card.appendChild(overlay);

        // create shards
        const shardCount = 7 + Math.floor(Math.random() * 6);
        for (let i = 0; i < shardCount; i++) {
          const shard = document.createElement('div');
          shard.className = 'shard';
          const poly = generateRandomPolygon();
          shard.style.clipPath = `polygon(${poly.join(',')})`;
          shard.style.left = '0';
          shard.style.top = '0';
          const dirX = (Math.random() - 0.5) * 2;
          const dirY = (Math.random() - 0.3) * -1.4;
          const distance = 40 + Math.random() * 160;
          const tx = Math.round(dirX * distance) + 'px';
          const ty = Math.round(dirY * distance) + 'px';
          const rot = Math.round((Math.random() - 0.5) * 720) + 'deg';
          const dur = (900 + Math.random() * 900) + 'ms';
          const delay = Math.round(Math.random() * 140) + 'ms';
          shard.style.setProperty('--tx', tx);
          shard.style.setProperty('--ty', ty);
          shard.style.setProperty('--rot', rot);
          shard.style.animation = `shardFly ${dur} ${Math.random() < 0.5 ? 'cubic-bezier(.2,.8,.2,1)' : 'cubic-bezier(.25,.8,.25,1)'} ${delay} forwards`;

          overlay.appendChild(shard);
        }

        // small camera shake on card
        card.classList.add('aero-shake');
        setTimeout(() => card.classList.remove('aero-shake'), 700);

        // store overlays reference for repair; keep compatibility with single _crackOverlay
        overlays.push(overlay);
        card._crackOverlays = overlays;
        card._crackOverlay = overlay;

        showRepair(true);
      }

      function repairAll() {
        document.querySelectorAll('.aero-card.shattered').forEach(c => {
          c.classList.remove('shattered');
          // remove all overlays if present
          if (Array.isArray(c._crackOverlays) && c._crackOverlays.length) {
            c._crackOverlays.forEach(o => {
              try {
                o.style.transition = 'opacity .35s ease';
                o.style.opacity = '0';
                setTimeout(() => { if (o && o.parentNode) o.parentNode.removeChild(o); }, 380);
              } catch (e) { /* ignore */ }
            });
            c._crackOverlays = [];
            c._crackOverlay = null;
            return;
          }
          // fallback to previous single overlay field
          if (c._crackOverlay) {
            c._crackOverlay.style.transition = 'opacity .35s ease';
            c._crackOverlay.style.opacity = '0';
            setTimeout(() => { if (c._crackOverlay && c._crackOverlay.parentNode) c._crackOverlay.parentNode.removeChild(c._crackOverlay); c._crackOverlay = null; }, 380);
          }
        });
        showRepair(false);
      }

      function bindShatterHandlers() {
        const cards = $$('.aero-card');
        cards.forEach(card => {
          const onPointerDown = e => {
            if (e.pointerType === 'mouse' && e.button !== 0) return;
            const cnt = incrementClick(card);
            if (cnt >= 5) { shatter(card, e.clientX, e.clientY); resetCount(card); }
          };
          const onClick = e => {
            if (e.button && e.button !== 0) return;
            const cnt = incrementClick(card);
            if (cnt >= 5) { shatter(card, e.clientX, e.clientY); resetCount(card); }
          };
          card.addEventListener('pointerdown', onPointerDown);
          card.addEventListener('click', onClick);
        });
      }

      // Convert .card elements inside sidebar to .aero-card for consistent behavior
      (function convertSidebarCards() {
        const aside = $('.sidebar');
        if (!aside) return;
        const existingGrid = $('.aero-grid', aside);
        const cards = $$('.card', aside);
        if (cards.length === 0) return;
        let grid = existingGrid;
        if (!grid) {
          grid = document.createElement('div');
          grid.className = 'aero-grid';
          aside.appendChild(grid);
        }
        cards.forEach(c => {
          c.classList.remove('card');
          c.classList.add('aero-card');
          grid.appendChild(c);
        });
      })();

      bindShatterHandlers();

      if (repairBtn) {
        repairBtn.addEventListener('click', repairAll);
        showRepair(false);
      }

      // ---------- Preload overlay (index only) ----------
      (function preloadFlow() {
        try {
          const overlay = document.getElementById('preload-overlay');
          if (!overlay) return;
          const prog = overlay.querySelector('.progress');
          const label = overlay.querySelector('.progress-label');
          const title = overlay.querySelector('.pre-title');
          const headerTitle = document.querySelector('.site-title');

          // show overlay (fade in)
          overlay.classList.add('visible');
          // keep header title hidden while preloading
          document.body.classList.add('preloading');

          let value = 0;
          const tick = () => {
            // increase towards 80% while loading
            if (value < 80) value += 4 + Math.random() * 6;
            value = Math.min(80, value);
            prog.style.width = value + '%';
            prog.setAttribute('aria-valuenow', Math.round(value));
          };
          const iv = setInterval(tick, 120);

          // when everything loaded
          window.addEventListener('load', () => {
            clearInterval(iv);
            // finish bar
            prog.style.width = '100%';
            prog.setAttribute('aria-valuenow', 100);

            // set Done! label
            try { if (label) label.textContent = 'Done!'; } catch (e) {}

            // compute transform to move pre-title into header title position
            const ptRect = title.getBoundingClientRect();
            const htRect = headerTitle.getBoundingClientRect();

            const dx = (htRect.left + htRect.width/2) - (ptRect.left + ptRect.width/2);
            const dy = (htRect.top + htRect.height/2) - (ptRect.top + ptRect.height/2);
            const scale = Math.min(1, htRect.width / ptRect.width);

            // animate move + shrink
            title.style.transition = 'transform 560ms cubic-bezier(.2,.9,.2,1), opacity 360ms ease';
            title.style.transform = `translate(${dx}px, ${dy}px) scale(${scale})`;
            title.style.opacity = '0.95';

            // wait for the move to finish then fade overlay
            setTimeout(() => {
              overlay.classList.add('hidden');
              // reveal header title
              document.body.classList.remove('preloading');
              // cleanup styles after transition
              setTimeout(() => {
                try { overlay.parentNode && overlay.parentNode.removeChild(overlay); } catch (e) { }
              }, 520);

              // after hiding overlay, navigate to homepage if not already on it
              try {
                const path = location.pathname || '';
                const onIndex = /index\.html?$/.test(path) || path === '/';
                if (!onIndex) {
                  // small delay so user sees "Done!"
                  setTimeout(() => { location.href = 'index.html'; }, 320);
                }
              } catch (e) { /* ignore */ }

            }, 620);
          }, { once: true });
        } catch (e) { /* ignore */ }
      })();

    })();
  </script>
</body>

</html></html>