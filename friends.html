<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>KoaSayi-Friends!</title>
    <link rel="stylesheet" href="styles.css" />
</head>

<body>
    <p> 该网页可能保留，亦有可能移除，具体以发布正式版的KoaSayi网站时的情况为准。</p>
    <header class="site-header">
        <div class="wrap">
            <h1 class="site-title">Friends</h1>
            <p class="site-desc">是你们造就了现在的我..对此感激不尽!</p>
            <button id="theme-toggle-friends" class="theme-toggle" aria-label="切换主题">换!</button>
        </div>
    </header>

    <main class="wrap">
        <section class="friends-hero">
            <h2>Friends</h2>
            <p>点击标题就能访问对方站点..应该吧?</p>
        </section>

        <section class="friends-grid" id="friends-grid">
            <!-- 由 friends.json 动态渲染友链卡片 -->
        </section>

        <p style="margin-top:1rem"><a href="index.html">← 返回首页</a></p>
    </main>

    <footer class="site-footer">
        <div class="wrap footer-row">
            <p>© 2025 KoaSayi。</p>
            <div class="footer-right"><a class="friend-link-btn" href="friends.html">副驾驶把友链的链接页放这来了，我不知道为什么..</a></div>
        </div>
    </footer>

</body>

<script>
    (function () {
        const toggle = document.getElementById('theme-toggle-friends');
        const doc = document.documentElement;
        // 优先使用 localStorage 的主题设置；没有时跟随系统偏好
        const stored = localStorage.getItem('theme');
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const apply = (isDark) => {
            doc.setAttribute('data-theme', isDark ? 'dark' : 'light');
            if (toggle) toggle.textContent = isDark ? '我怕暗' : '我怕亮';
            if (toggle) toggle.setAttribute('aria-pressed', isDark ? 'true' : 'false');
        };
        // 初始化
        if (stored === 'dark' || (stored === null && prefersDark)) apply(true);
        else apply(false);

        if (toggle) {
            toggle.addEventListener('click', () => {
                const isDark = doc.getAttribute('data-theme') === 'dark';
                const next = !isDark;
                apply(next);
                localStorage.setItem('theme', next ? 'dark' : 'light');
            });
        }
        // 监听系统偏好变化（如果用户未设置 localStorage）
        if (window.matchMedia) {
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                if (!localStorage.getItem('theme')) apply(e.matches);
            });
        }

        // ============== friends.json 加载与渲染 ==============
        function escapeHtml(s) { return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }
        async function loadFriends() {
            const container = document.getElementById('friends-grid');
            if (!container) { console.warn('friends-grid not found'); return; }
            try {
                const res = await fetch('friends.json', { cache: 'no-store' });
                if (!res.ok) throw new Error('fetch failed: ' + res.status);
                const list = await res.json();
                container.innerHTML = '';
                list.forEach(f => {
                    const a = document.createElement('article');
                    a.className = 'friend-card';
                    a.innerHTML = `\n                        <img class="friend-avatar" src="${escapeHtml(f.avatar)}" alt="${escapeHtml(f.name)}">\n                        <div class="friend-meta">\n                          <h4><a href="${escapeHtml(f.url)}" target="_blank" rel="noopener">${escapeHtml(f.name)}</a></h4>\n                          <p>${escapeHtml(f.desc)}</p>\n                        </div>`;
                    container.appendChild(a);
                });
            } catch (err) {
                console.error('loadFriends error', err);
                container.innerHTML = '<p>加载友链失败，请稍后重试。</p>';
            }
        }
        // 加载完后绑定鼠标移动效果
        loadFriends().then(() => {
            setupMouseGlow();
        });

        function setupMouseGlow() {
            const container = document.getElementById('friends-grid');
            if (!container) return;
            // 为动态创建的 card 绑定 mousemove
            container.addEventListener('mousemove', e => {
                const cards = container.querySelectorAll('.friend-card');
                cards.forEach(card => {
                    const r = card.getBoundingClientRect();
                    const x = e.clientX - r.left;
                    const y = e.clientY - r.top;
                    const px = (x / r.width) * 100;
                    const py = (y / r.height) * 100;
                    card.style.setProperty('--mx', px + '%');
                    card.style.setProperty('--my', py + '%');
                    card.classList.add('hovering');
                });
            });
            container.addEventListener('mouseleave', () => {
                const cards = container.querySelectorAll('.friend-card');
                cards.forEach(card => {
                    card.style.removeProperty('--mx');
                    card.style.removeProperty('--my');
                    card.classList.remove('hovering');
                });
            });

            // 支持触摸移动（移动手指时更新光点）
            container.addEventListener('touchmove', e => {
                const touch = e.touches[0];
                if (!touch) return;
                const cards = container.querySelectorAll('.friend-card');
                cards.forEach(card => {
                    const r = card.getBoundingClientRect();
                    const x = touch.clientX - r.left;
                    const y = touch.clientY - r.top;
                    const px = (x / r.width) * 100;
                    const py = (y / r.height) * 100;
                    card.style.setProperty('--mx', px + '%');
                    card.style.setProperty('--my', py + '%');
                    card.classList.add('hovering');
                });
            }, { passive: true });
            container.addEventListener('touchend', () => {
                const cards = container.querySelectorAll('.friend-card');
                cards.forEach(card => {
                    card.style.removeProperty('--mx');
                    card.style.removeProperty('--my');
                    card.classList.remove('hovering');
                });
            });
        }
    })();
</script>

</html>